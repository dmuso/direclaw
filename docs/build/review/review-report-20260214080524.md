# DireClaw Codebase Review Report (2026-02-14 08:05:24)

Scope reviewed:
- Source: `src/`, `src/bin/`, `tests/`
- Specs: `docs/build/spec/01-12` (with emphasis on `docs/build/spec/12-reliability-compat-testing.md`)
- Validation run in Nix shell: `cargo fmt --all -- --check`, `cargo clippy --all-targets --all-features -- -D warnings`, `cargo test --all` (all passed)

## Actionable Tasks

1. Implement the required CLI/daemon command surface (currently missing).
Evidence:
- Spec requires command set and config lifecycle: `docs/build/spec/09-configuration-cli.md:83`, `docs/build/spec/09-configuration-cli.md:115`, `docs/build/spec/10-daemon-operations.md:7`.
- Binary only bootstraps config and prints paths: `src/bin/direclaw.rs:4`, `src/bin/direclaw.rs:17`, `src/bin/direclaw.rs:24`.
Impact:
- Major product contract gap; spec acceptance criteria in sections 09/10 cannot be met.
Fix path:
- Replace single-path bootstrap binary with subcommand-based CLI (start/stop/restart/status/logs/setup/send/update/attach/orchestrator/workflow/channel-profile/provider/model/agent/channels reset).
- Add command handlers that read/write settings/orchestrator config without manual YAML edits.
Add tests:
- Integration tests for each required subcommand and failure modes (unknown orchestrator, invalid shared key, invalid workflow id).

2. Fix workflow routing bug: `workflowRunId` always forces status action instead of run continuation.
Evidence:
- Spec precedence: status fast-path only for explicit status commands; otherwise route to run: `docs/build/spec/02-queue-processing.md:53`, `docs/build/spec/05-workflow-orchestration.md:424`.
- Current code routes any message with `workflow_run_id` to synthesized `workflow_status`: `src/orchestrator.rs:1633`, `src/orchestrator.rs:1658`, `src/orchestrator.rs:1666`.
Impact:
- In-run user messages cannot advance workflow work; behavior deviates from core orchestration contract.
Fix path:
- Parse inbound intent for explicit status/progress commands.
- For non-status messages with `workflowRunId`, route into run step execution path.
Add tests:
- Integration test: message with `workflowRunId` and non-status text advances run; status text remains read-only.

3. Wire real provider execution into selector/workflow/diagnostics paths.
Evidence:
- Spec requires provider CLI execution for selector, step, diagnostics: `docs/build/spec/03-agent-routing-execution.md:27`, `docs/build/spec/06-provider-integration.md:9`.
- Orchestrator uses callback-fed raw selector output, no provider call: `src/orchestrator.rs:1728`.
- `run_provider` exists but is unused by production flow (only tests): `src/provider.rs:197`, `tests/provider_runner.rs:58`.
Impact:
- Core runtime behavior is simulated, not implemented end-to-end.
Fix path:
- In orchestrator execution path, build prompt artifacts, resolve agent/provider/model/cwd, call `run_provider`, parse outputs, persist invocation logs.
Add tests:
- Integration test with real local provider binary invocation contract (or contract harness) from orchestrator entry to selector result persistence.

4. Close path traversal vulnerability in persisted artifact filenames.
Evidence:
- Unsanitized identifiers are used in file paths: `src/orchestrator.rs:313`, `src/orchestrator.rs:324`, `src/orchestrator.rs:335`, `src/orchestrator.rs:1418`, `src/orchestrator.rs:1706`.
- `message_id` is channel-originated input (`IncomingMessage`): `src/queue.rs:35`.
Impact:
- Malicious IDs containing path separators/`..` can write outside intended directories or clobber neighboring files.
Fix path:
- Introduce typed/sanitized ID wrappers (`MessageId`, `SelectorId`, `RunId`) with strict allowed charset.
- Reject unsafe IDs at queue-ingress and before file persistence.
Add tests:
- Security tests for `../`, absolute paths, separators, unicode confusables, and overly long IDs.

5. Implement missing channel adapters and outbound processing workers.
Evidence:
- Spec requires discord/telegram/whatsapp/slack adapters: `docs/build/spec/07-channel-adapters.md:7`.
- No adapter modules or runtime worker implementations exist; exported modules are only config/orchestrator/provider/queue/runtime: `src/lib.rs:1`.
Impact:
- No real inbound/outbound channel behavior despite queue schema support.
Fix path:
- Add adapter modules and worker lifecycle integration in runtime supervisor.
- Implement outbound polling (1s), file-first sending, pending-correlation cleanup, Slack thread behavior.
Add tests:
- Adapter mapping tests, outbound chunking/threading tests, and workflow-status/diagnostics intent routing tests per channel.

6. Implement heartbeat service and active-run periodic progress posting.
Evidence:
- Spec requires heartbeat worker and 15-minute progress cadence: `docs/build/spec/11-heartbeat-service.md:9`, `docs/build/spec/05-workflow-orchestration.md:507`.
- Only enum placeholder exists; no scheduler/worker implementation: `src/runtime.rs:91`, `src/runtime.rs:101`.
Impact:
- Liveness/progress observability requirements are unmet.
Fix path:
- Implement heartbeat scheduler (`monitoring.heartbeat_interval`) and enqueue logic per configured agent.
- Implement periodic active-run progress refresh and Slack progress posting cadence.
Add tests:
- Cadence tests, missing `heartbeat.md` fallback tests, and progress post eligibility tests.

7. Complete diagnostics investigation flow to meet bounded retrieval and auditability requirements.
Evidence:
- Spec requires two-phase diagnostics with bounded retrieval and provenance: `docs/build/spec/05-workflow-orchestration.md:268`, `docs/build/spec/05-workflow-orchestration.md:299`, `docs/build/spec/05-workflow-orchestration.md:333`.
- Current implementation returns simple synthesized text from `progress.json` only: `src/orchestrator.rs:1522`, `src/orchestrator.rs:1593`.
Impact:
- Diagnostics lacks evidence collection depth, bounds enforcement, and provider reasoning phase.
Fix path:
- Implement scoped artifact/log retrieval with hard limits and provenance fields.
- Add diagnostics provider prompt/context artifacts and invocation log persistence.
Add tests:
- Ambiguous scope fallback, bounded retrieval limits, and insufficient-confidence response behavior.

8. Expand selector function registry to full command parity and argument schemas.
Evidence:
- Spec requires selector-callable parity for CLI/daemon commands with argument schema metadata: `docs/build/spec/09-configuration-cli.md:184`, `docs/build/spec/10-daemon-operations.md:24`.
- Current registry only supports 3 function IDs and no arg schema metadata: `src/orchestrator.rs:1242`, `src/orchestrator.rs:1261`, `src/orchestrator.rs:1287`.
Impact:
- Natural-language command routing cannot satisfy required operational coverage.
Fix path:
- Add command-aligned function catalog with machine-readable arg schemas.
- Validate args strongly before invocation and return typed contract errors.
Add tests:
- Contract tests for each function ID: required args, invalid types, unknown args, and read-only guarantees for status/progress.

9. Replace fake selector/provider test patterns with higher-fidelity integration coverage.
Evidence:
- Provider tests use shell mock scripts, not actual provider contract integration: `tests/provider_runner.rs:43`, `tests/provider_runner.rs:69`.
- Orchestrator selector tests inject inline JSON via closure callback, bypassing provider pipeline: `tests/orchestrator_workflow_engine.rs:576`, `src/orchestrator.rs:1728`.
Impact:
- High confidence in helper parsing, lower confidence in real orchestration behavior.
Fix path:
- Keep unit mocks, but add integration layer with process-level contract harness that exercises full orchestrator->provider->parser->persistence flow.
Add tests:
- End-to-end smoke for `incoming -> orchestrator selection -> workflow action -> outgoing` with artifact checks.

10. Add migration and restart-recovery implementation/tests for compatibility requirements.
Evidence:
- Spec mandates migrate command and legacy compatibility: `docs/build/spec/12-reliability-compat-testing.md:31`, `docs/build/spec/12-reliability-compat-testing.md:33`.
- No `migrate` command in CLI implementation (`src/bin/direclaw.rs` has no subcommands): `src/bin/direclaw.rs:4`.
- No tests for restart recovery of partially moved processing files.
Impact:
- Release-readiness and backward compatibility are unproven.
Fix path:
- Implement `direclaw migrate` and legacy payload/file-tag compatibility tooling.
- Add startup recovery scan for orphaned `processing` entries.
Add tests:
- Migration fixture tests and crash/restart lifecycle tests.

11. Remove or integrate currently unused production paths to reduce maintenance risk.
Evidence:
- `PerKeyScheduler` and ordering-key logic are tested but not wired into orchestration runtime: `src/queue.rs:134`, `src/queue.rs:170`.
- Provider helper APIs are not used by orchestrator runtime: `src/provider.rs:197`, `src/provider.rs:436`, `src/provider.rs:457`.
Impact:
- Duplicate conceptual paths (implemented helpers vs non-using runtime) increase drift risk.
Fix path:
- Integrate these components into runtime workers or remove/de-scope until needed.
Add tests:
- Runtime-level ordering tests proving per-key sequential behavior under queue worker concurrency.

12. Improve type safety and domain modeling to reduce stringly-typed control flow.
Evidence:
- Many core IDs/fields are raw strings (`provider`, `channel`, `step_type`, function IDs): `src/config.rs:56`, `src/config.rs:87`, `src/config.rs:113`, `src/orchestrator.rs:1189`.
Impact:
- Higher risk of invalid state and fragile cross-module contracts.
Fix path:
- Introduce enums/newtypes for provider/channel/workflow IDs and validated function IDs.
- Enforce parsing/validation at boundaries and pass typed values internally.
Add tests:
- Parsing and serde round-trip tests for new domain types and invalid-input rejection cases.

## Additional Notes

- No skipped tests, `TODO`, or `unimplemented!` markers were found in `src/` or `tests/`.
- Prophet architecture checks are not applicable to this repository in its current state (no UI/component system, analytics DSL, or backend domain terms matching that stack were found).
